<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.119.0">
<link rel="canonical" type="text/html" href="https://dell.github.io/azurestack-docs/docs/hci/storagestack/">
<link rel="alternate" type="application/rss&#43;xml" href="https://dell.github.io/azurestack-docs/docs/hci/storagestack/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="https://dell.github.io/azurestack-docs/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="https://dell.github.io/azurestack-docs/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="https://dell.github.io/azurestack-docs/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="https://dell.github.io/azurestack-docs/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://dell.github.io/azurestack-docs/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="https://dell.github.io/azurestack-docs/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="https://dell.github.io/azurestack-docs/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="https://dell.github.io/azurestack-docs/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="https://dell.github.io/azurestack-docs/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="https://dell.github.io/azurestack-docs/favicons/android-192x192.png" sizes="192x192">

<title>Storage Stack | Solutions for Microsoft Azure Stack</title>
<meta name="description" content="Dell Technologies (Dell) Azure Stack documentation pages">
<meta property="og:title" content="Storage Stack" />
<meta property="og:description" content="Dell Technologies (Dell) Azure Stack documentation pages" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://dell.github.io/azurestack-docs/docs/hci/storagestack/" />
<meta itemprop="name" content="Storage Stack">
<meta itemprop="description" content="Dell Technologies (Dell) Azure Stack documentation pages"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Storage Stack"/>
<meta name="twitter:description" content="Dell Technologies (Dell) Azure Stack documentation pages"/>



<link rel="preload" href="https://dell.github.io/azurestack-docs/scss/main.min.f28669251d295836018a6bbf5273ec7f332a49449f7c4fed679c156d07249b58.css" as="style">
<link href="https://dell.github.io/azurestack-docs/scss/main.min.f28669251d295836018a6bbf5273ec7f332a49449f7c4fed679c156d07249b58.css" rel="stylesheet" integrity="">


<link id="dark-mode-theme" rel="stylesheet" href="https://dell.github.io/azurestack-docs/css/dark.css" />

<script>
    function disableDarkTheme(mode) {
        if (mode === "light") {
            var darkTheme = document.getElementById("dark-mode-theme");

            darkTheme.disabled = true;
        }

        localStorage.setItem("dark-mode-storage", mode);
    }

    
    var savedTheme = localStorage.getItem("dark-mode-storage") || "light";
    disableDarkTheme(savedTheme);
</script>
<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script defer
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://dell.github.io/azurestack-docs/css/prism.css"/>
<link disabled id="prism-night-owl" rel="stylesheet" href="https://dell.github.io/azurestack-docs/css/prism-nightowl.css">
<link id="home-page-override" rel="stylesheet" href="https://dell.github.io/azurestack-docs/css/homepage.css">

<script async src="https://www.googletagmanager.com/gtag/js?id=G-PXKTSNG8VW"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-PXKTSNG8VW', { 'anonymize_ip': false });
}
</script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="https://dell.github.io/azurestack-docs/">
		<span class="navbar-logo"><svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1017 132"><defs><style>.cls-1{fill:#fff}</style></defs><title>DellTech_Logo_Prm_Wht_rgb</title><path class="cls-1" d="M1015 84.89c0-12.23-6.8-17.66-20.39-20.38s-21.73-4.08-21.73-13.58c0-6.8 5.44-10.87 15-10.87 12.22.0 16.3 5.43 16.3 12.22l1.36 1.36h5.43l1.37-1.36c0-13.58-10.88-19-24.46-19-15 0-23.1 8.15-23.1 17.67.0 10.86 8.15 16.3 21.73 19s20.38 4.08 20.38 15c0 6.79-4.07 12.23-17.66 12.23-12.22.0-17.66-6.8-17.66-15l-1.35-1.36h-5.44l-1.35 1.36c0 12.23 9.5 21.74 25.8 21.74 17.66.0 25.82-8.15 25.82-19M956.58 71.31l1.36-1.37V65.87c0-19-10.87-32.61-29.89-32.61s-29.89 13.59-29.89 32.61v2.72c0 19 9.51 35.32 31.25 35.32 19 0 25.81-12.23 27.17-20.38l-1.36-1.36h-5.43l-1.36 1.36c-2.72 8.15-8.16 13.59-19 13.59-17.66.0-23.1-16.31-23.1-24.46l1.36-1.35zm-8.15-6.8H907.67l-1.36-1.36c0-9.51 5.44-23.09 21.74-23.09s21.74 13.58 21.74 23.09zm-59.78 36.68V36l-1.36-1.35h-5.43L880.5 36v65.22l1.36 1.36h5.43zm0-78.8V14.24l-1.36-1.36h-5.43l-1.36 1.36v8.15l1.36 1.36h5.43zM837 97.12c-13.59.0-21.74-9.52-21.74-28.53S823.44 40.06 837 40.06s21.73 9.5 21.73 28.53S850.61 97.12 837 97.12M858.76 93c0 17.66-4.07 31.25-20.38 31.25-12.22.0-16.3-5.44-17.66-12.23l-1.35-1.36h-5.44l-1.36 1.36c1.36 10.87 9.51 19 25.81 19 17.67.0 28.53-10.87 28.53-38V36l-1.35-1.35h-4.08L860.12 36l-1.36 8.16H857.4c-2.71-5.43-9.5-10.87-21.74-10.87-19 0-28.53 15-28.53 35.33s9.52 35.32 28.53 35.32c12.24.0 19-5.43 21.74-10.87zm-88.3-53c13.58.0 23.09 10.87 23.09 28.53S784 97.12 770.46 97.12s-23.1-10.87-23.1-28.53 9.51-28.53 23.1-28.53m0 63.85c17.66.0 31.25-12.23 31.25-35.32s-13.59-35.33-31.25-35.33-31.25 12.23-31.25 35.33 13.59 35.32 31.25 35.32m-40.76-2.72V8.81l-1.36-1.36h-5.43l-1.36 1.36v92.38l1.36 1.36h5.43zM680.8 40.06c13.58.0 23.09 10.87 23.09 28.53s-9.51 28.53-23.09 28.53-23.1-10.87-23.1-28.53 9.51-28.53 23.1-28.53m0 63.85c17.66.0 31.25-12.23 31.25-35.32S698.46 33.26 680.8 33.26s-31.25 12.23-31.25 35.33 13.59 35.32 31.25 35.32m-39.4-2.72V60.43c0-17.66-9.51-27.17-24.45-27.17-9.52.0-17.67 4.08-21.74 10.87h-1.36L592.49 36l-1.36-1.35h-4.08L585.7 36v65.22l1.35 1.36h5.44l1.36-1.36V64.51c0-15 6.79-24.45 21.73-24.45 10.87.0 17.66 6.79 17.66 20.37v40.76l1.37 1.36H640zm-69.29.0V60.43c0-17.66-9.51-27.17-24.45-27.17-9.52.0-17.66 4.08-21.74 10.87h-1.36V8.81L523.2 7.45h-5.43l-1.36 1.36v92.38l1.36 1.36h5.43l1.36-1.36V64.51c0-15 6.8-24.45 21.74-24.45 10.87.0 17.66 6.79 17.66 20.37v40.76l1.36 1.36h5.44zM455.28 68.59c0-19 9.5-28.53 23.09-28.53s19 8.15 20.38 16.29l1.35 1.37h5.44l1.36-1.37c-1.36-13.58-12.23-23.09-28.53-23.09-17.66.0-31.24 10.87-31.24 35.33s13.58 35.32 31.24 35.32c16.3.0 27.17-9.51 28.53-23.1l-1.36-1.36H500.1l-1.35 1.36C497.39 89 492 97.12 478.37 97.12s-23.09-9.52-23.09-28.53m-14.95 2.72 1.36-1.37V65.87c0-19-10.87-32.61-29.9-32.61s-29.88 13.59-29.88 32.61v2.72c0 19 9.51 35.32 31.25 35.32 19 0 25.81-12.23 27.17-20.38L439 82.17h-5.43l-1.36 1.36c-2.72 8.15-8.15 13.59-19 13.59-17.66.0-23.1-16.31-23.1-24.46l1.36-1.35zm-8.15-6.8H391.42l-1.36-1.36c0-9.51 5.44-23.09 21.73-23.09s21.75 13.58 21.75 23.09zM395.57 12.88V8.81l-1.36-1.36H323.56L322.2 8.81v4.07l1.36 1.36h29.89l1.36 1.36v85.59l1.36 1.36h5.43l1.36-1.36V15.6l1.36-1.36h29.89z"/><path class="cls-1" d="M322.2 83.65v18.9H260.85V7.45h21.6v76.2zM38.55 102.55A47.57 47.57.0 0084.58 67l53.8 42 53.77-42v35.56H253.5V83.65H213.75V7.45h-21.6V43L140.58 83.3l-11.54-9L153.73 55l26.89-21-15.35-12-51.58 40.3-11.53-9L153.73 13 138.38 1 84.58 43a47.57 47.57.0 00-46-35.58H0v95.1zM21.6 83.65V26.35H38.55c14.33.0 26 12.83 26 28.65s-11.67 28.65-26 28.65z"/></svg></span><span class="font-weight-bold">Solutions for Microsoft Azure Stack</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="https://dell.github.io/azurestack-docs/docs/" ><span class="active">Dell Technologies Solutions for Microsoft Azure Stack</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://github.com/dell/azurestack-docs" target="_blank" ><i class='fab fa-github fa-lg'></i><span>GitHub</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://dell.github.io/azurestack-docs/" ><i id='dark-mode-toggle' class='fa fa-moon'></i><span>Dark</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="https://dell.github.io/azurestack-docs/offline-search-index.a75978d5ce251f506b8c476ba20eb081.json"
  data-offline-search-base-href="https://dell.github.io/azurestack-docs/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="https://dell.github.io/azurestack-docs/docs/hci/storagestack/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Storage Stack</h1>





  
  <nav id="TableOfContents"></nav>
  


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-96b3a52d4f82da4ed58591457f666239">1 - Storage Stack Overview</h1>
    
	<p>Understanding storage stack is crucial for understanding what technologies are involved and how (where storage replica is, where is ReFS Multi-resilient Volume, &hellip;). Understanding how layers are stacked will also help when IO flow is troubleshooted - like reviewing performance counters or troubleshooting core functionality.</p>
<p>Traditional stack compared to storage spaces stack (note that MPIO is missing, but for Storage Spaces Direct it&rsquo;s not needed as there is only one path to the physical device, so it was omitted)</p>
<p><img src="StorageStack01.png" alt=""></p>
<p>You can notice 4 &ldquo;new&rdquo; layers, but actually it&rsquo;s just Spaces layer (Spaceport) and Storage Bus Layer.</p>
<p>To better understand what&rsquo;s in the stack, you can also explore some parts with PowerShell</p>
<p><img src="StorageStack02.png" alt=""></p>
<p>Anyway, let&rsquo;s explore layers a bit. Following info is based on storage description someone somewhere created and pushed to internet. The only version found was from webarchive and can be accessed <a href="Storage.pdf">here</a>.</p>
<h2 id="layers-below-s2d-stack">Layers below S2D Stack</h2>
<h3 id="port--miniport-driver">Port &amp; Miniport driver</h3>
<p><em><strong>storport.sys</strong></em> &amp; <em><strong>stornvme.sys</strong></em></p>
<p>Port drivers implement the processing of an I/O request specific to a type of I/O port, such as SATA, and are implemented as kernel-mode libraries of functions rather than actual device drivers. Port driver is written by Microsoft (<em><strong>storport.sys</strong></em>). If third party wants to use write their own device driver (like HBA), then it will use miniport driver (except if device is NVMe, then miniport driver is Microsoft <em><strong>stornvme.sys</strong></em>)</p>
<p>Miniport drivers usually use <em><strong>storport.</strong></em> performance enhancements such as support for the paralell execution of IO.</p>
<p><a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/storage/storage-port-drivers">storage port drivers</a>
<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/storage/storage-miniport-drivers">storage miniport drivers</a></p>
<h3 id="class-driver">Class Driver</h3>
<p><em><strong>disk.sys</strong></em></p>
<p>A <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/storage/introduction-to-storage-class-drivers">storage class driver</a> (typically <em><strong>disk.sys</strong></em>) uses the well-established SCSI class/port interface to control a mass storage device of its type on any bus for which the system supplies a storage port driver (currently SCSI, IDE, USB and IEEE 1394). The particular bus to which a storage device is connected is transparent to the storage class driver.</p>
<p>Storage class driver is responsible for claiming devices, interpreting system I/O requests and <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/storage/storage-class-driver-s-general-functionality">many more</a></p>
<p>In Storage Spaces stack (Virtual Disk) <em><strong>disk.sys</strong></em> is responsible for claiming Virtual Disk exposed by spaceport (storage spaces)</p>
<p><img src="StorageStack03.png" alt=""></p>
<h3 id="partition-manager">Partition Manager</h3>
<p><em><strong>partmgr.sys</strong></em></p>
<p>Partitions are handled by <em><strong>partmgr.sys</strong></em>. Partition is usually GPT or MBR (preferably GPT as MBR has many limitations such as 2TB size limit)</p>
<p>As you can see in the stack, there are two partition managers. One partition layout is on physical disk and it is then consumed by storage spaces (spaceport).</p>
<p>On the picture below you can see individual physical disk from spaces exposed and it&rsquo;s partitions showing metadata partition and partition containing pool data (normally not visible as it&rsquo;s hidden by <em><strong>partmgr.sys</strong></em> when it detects spaces).</p>
<p><img src="StorageStack04.png" alt=""></p>
<p><img src="StorageStack05.png" alt=""></p>
<h2 id="s2d-stack">S2D Stack</h2>
<h3 id="storage-bus-layer">Storage Bus Layer</h3>
<p><em><strong>clusport.sys</strong></em> and <em><strong>clusblft.sys</strong></em></p>
<p>These two drivers (client/server) are exposing all physical disk to each cluster node, so it looks like all physical disks from every cluster node are connected to each server. For interconnect is SMB used, therefore high-speed RDMA can be used (recommended).</p>
<p>It also contains SBL cache.</p>
<h3 id="spaceport">Spaceport</h3>
<p><em><strong>spaceport.sys</strong></em></p>
<p>Claims disks and adds them to storage spaces pool. It creates partitions where internal data structures are metadata are kept (see screenshot in partition manager).</p>
<p>Defines resiliency when volume (virtual disk) is created (creates/distributes extents across physical disks)</p>
<h3 id="virtual-disk">Virtual Disk</h3>
<p><em><strong>disk.sys</strong></em> is now used by storage spaces and exposes virtual disk that was provisioned using <em><strong>spaceport.sys</strong></em></p>
<p><img src="StorageStack06.png" alt=""></p>
<p><img src="StorageStack07.png" alt=""></p>
<h2 id="layers-above-s2d-stack">Layers above S2D Stack</h2>
<h3 id="volume-manager">Volume Manager</h3>
<p><em><strong>dmio.sys</strong></em>, <em><strong>volmgr.sys</strong></em></p>
<p>Volumes are created on top of the partition and on volumes you can then create filesystems and expose it to the components higher in the stack.</p>
<p><img src="StorageStack08.png" alt=""></p>
<h3 id="volume-snapshot">Volume Snapshot</h3>
<p><em><strong>volsnap.sys</strong></em></p>
<p>Volsnap is the component that creates system provider for the volume <a href="https://learn.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service">shadow copy service (VSS)</a>. This service is controller by <em><strong>vssadmin.exe</strong></em></p>
<h3 id="bitlocker">BitLocker</h3>
<p><em><strong>fvevol.sys</strong></em></p>
<p>BitLocker is well known disk encryption software that is on the market since Windows Vista. In PowerShell you can expose volume status with <strong>Get-BitLockerVolume</strong> command.</p>
<p><img src="StorageStack09.png" alt=""></p>
<h3 id="filter-drivers">Filter Drivers</h3>
<p>Interesting about filter drivers is, that all FileSystem drivers are actually filter drivers - special ones, File System Drivers - like <em><strong>REFS.sys</strong></em>, <em><strong>NTFS.sys</strong></em>, <em><strong>Exfat.sys</strong></em>.</p>
<p>You can learn more about filesystem using fsutil</p>
<p><img src="StorageStack10.png" alt=""></p>
<p>There are also many first party and third party filter drivers. You can expose those with fltmc command</p>
<p><img src="StorageStack11.png" alt=""></p>
<p>As you can see on above example, there are many filters like Cluster Shared Volume (CsvNSFlt, CsvFLT), deduplication (Dedup), shared vhd (svhdxflt), storage QoS (storqosflt) and many more. Each filter driver has defined altitude and 3rd parties can <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ifs/allocated-altitudes">reserve theirs</a>.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-64d65c6384cd494a50a15bef8ab6c8ee">2 - Layers Below S2D Stack</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-54f27f709ce186a296e60f45e7e23649">2.1 - Storage Devices</h1>
    
	<!-- TOC -->
<ul>
<li><a href="#storage-devices">Storage Devices</a>
<ul>
<li><a href="#resources">Resources</a></li>
<li><a href="#interfaces">Interfaces</a></li>
<li><a href="#storage-protocol">Storage Protocol</a></li>
<li><a href="#storage-configurations">Storage Configurations</a></li>
<li><a href="#os-disks">OS Disks</a></li>
<li><a href="#consumer-grade-ssds">Consumer-Grade SSDs</a></li>
<li><a href="#exploring-stack-with-powershell">Exploring Stack with PowerShell</a>
<ul>
<li><a href="#get-physicaldisk">Get-PhysicalDisk</a></li>
<li><a href="#storage-reliability-counter">Storage Reliability Counter</a></li>
</ul>
</li>
<li><a href="#performance-results">Performance results</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<p><img src="Stack-PhysicalDisks.png" alt=""></p>
<h2 id="resources">Resources</h2>
<p>Microsoft Documentation</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure-stack/hci/concepts/choose-drives">https://learn.microsoft.com/en-us/azure-stack/hci/concepts/choose-drives</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure-stack/hci/concepts/drive-symmetry-considerations">https://learn.microsoft.com/en-us/azure-stack/hci/concepts/drive-symmetry-considerations</a></li>
</ul>
<p>NVMe vs SATA</p>
<ul>
<li><a href="https://sata-io.org/sites/default/files/documents/NVMe%20and%20AHCI%20as%20SATA%20Express%20Interface%20Options%20-%20Whitepaper_.pdf">https://sata-io.org/sites/default/files/documents/NVMe%20and%20AHCI%20as%20SATA%20Express%20Interface%20Options%20-%20Whitepaper_.pdf</a></li>
<li><a href="http://www.nvmexpress.org/wp-content/uploads/2013/04/IDF-2012-NVM-Express-and-the-PCI-Express-SSD-Revolution.pdf">http://www.nvmexpress.org/wp-content/uploads/2013/04/IDF-2012-NVM-Express-and-the-PCI-Express-SSD-Revolution.pdf</a></li>
<li><a href="https://nvmexpress.org/wp-content/uploads/NVMe-101-1-Part-2-Hardware-Designs_Final.pdf">https://nvmexpress.org/wp-content/uploads/NVMe-101-1-Part-2-Hardware-Designs_Final.pdf</a></li>
<li><a href="https://nvmexpress.org/wp-content/uploads/NVMe_Infrastructure_final1.pdf">https://nvmexpress.org/wp-content/uploads/NVMe_Infrastructure_final1.pdf</a></li>
<li><a href="https://www.storagereview.com/review/dell-emc-poweredge-r750-hands-on">https://www.storagereview.com/review/dell-emc-poweredge-r750-hands-on</a></li>
<li><a href="https://dl.dell.com/manuals/common/dellemc-nvme-io-topologies-poweredge.pdf">https://dl.dell.com/manuals/common/dellemc-nvme-io-topologies-poweredge.pdf</a></li>
<li><a href="https://www.servethehome.com/dell-emc-poweredge-r7525-review-flagship-dell-dual-socket-server-amd-epyc/">https://www.servethehome.com/dell-emc-poweredge-r7525-review-flagship-dell-dual-socket-server-amd-epyc/</a></li>
</ul>
<h2 id="interfaces">Interfaces</h2>
<p>While SATA is still well performing for most of the customers (see performance results), NVMe offers benefit of higher capacity and also more effective protocol (AHCI vs NVMe), that was developed specifically for SSDs (opposite to AHCI, that was developed for spinning media). SATA/SAS is however not scaling well with the larger disks.</p>
<p><img src="ScalablePerformance.png" alt=""></p>
<ul>
<li>Source: <a href="https://nvmexpress.org/wp-content/uploads/NVMe-101-1-Part-2-Hardware-Designs_Final.pdf">https://nvmexpress.org/wp-content/uploads/NVMe-101-1-Part-2-Hardware-Designs_Final.pdf</a></li>
</ul>
<p>There is also another aspect of performance limitation of SATA/SAS devices - the controller. All SATA/SAS devices are connected to one SAS controller (non-raid) that has limited speed (only one PCI-e connection).</p>
<p>Drive Connector is universal (U2, also known as SFF-8639)</p>
<p><img src="DriveConnector.png" alt=""></p>
<ul>
<li>Source: <a href="https://nvmexpress.org/wp-content/uploads/NVMe_Infrastructure_final1.pdf">https://nvmexpress.org/wp-content/uploads/NVMe_Infrastructure_final1.pdf</a></li>
</ul>
<p>NVMe drives are mapped directly to CPU</p>
<p><img src="NVMeDriveMapping.png" alt=""></p>
<ul>
<li>Source: <a href="https://dl.dell.com/manuals/common/dellemc-nvme-io-topologies-poweredge.pdf">https://dl.dell.com/manuals/common/dellemc-nvme-io-topologies-poweredge.pdf</a></li>
</ul>
<p>NVMe backplane connection - Example AX7525 - 16 PCIe Gen4 lanes in each connection (8 are used), 12 connections in backplane, in this case no PCIe switches.</p>
<p><img src="AX7525Backplane.png" alt=""></p>
<ul>
<li>Source: <a href="https://www.servethehome.com/dell-emc-poweredge-r7525-review-flagship-dell-dual-socket-server-amd-epyc/dell-emc-poweredge-r7525-internal-view-24x-nvme-backplane-and-fans/">https://www.servethehome.com/dell-emc-poweredge-r7525-review-flagship-dell-dual-socket-server-amd-epyc/dell-emc-poweredge-r7525-internal-view-24x-nvme-backplane-and-fans/</a></li>
</ul>
<h2 id="storage-protocol">Storage Protocol</h2>
<p>SSDs were originally created to replace conventional rotating media. As such they were designed to connect to the same bus types as HDDs, both SATA and SAS (Serial ATA and Serial Attached SCSI).</p>
<p>However, this imposed speed limitations on the SSDs.  Now a new type of SSD exists that attaches to PCI-e. Known as NVMe SSDs or simply NVMe.</p>
<p>For 1M IOPS, NVMe has more than <a href="https://www.nvmexpress.org/wp-content/uploads/2013/04/IDF-2012-NVM-Express-and-the-PCI-Express-SSD-Revolution.pdf">50% less latency with less than 50% CPU Cycles used</a>. It is due to <a href="https://en.wikipedia.org/wiki/NVM_Express#Comparison_with_AHCI">improved protocol</a> (AHCI vs NVMe)</p>
<h2 id="storage-configurations">Storage Configurations</h2>
<p>(slowest to fastest)</p>
<ul>
<li>Hybrid (HDD+SSD)</li>
<li>All Flash (All SSD)</li>
<li>NVMe+HDD</li>
<li>All-NVMe</li>
</ul>
<p>When combining multiple media types, faster media will be used as caching. While it is recommended to use 10% of the capacity for cache, it should be noted, that it is just important to not spill the cache with the production workload, as it will dramatically reduce performance. Therefore all production workload should fit into the Storage Bus Layer Cache (cache devices). The sweet spot (price vs performance) is combination of fast NVMe (mixed use or write intensive) with HDDs. For performance intensive workloads it&rsquo;s recommended to use all-flash solutions as caching introduces ~20% overhead + less predicable behavior (data can be already destaged&hellip;), therefore it is recommended to use All-Flash for SQL workloads.</p>
<p>Performance drop when spilling cache devices:</p>
<p><img src="CachePerfDrop.png" alt=""></p>
<ul>
<li>Source: <a href="https://web.archive.org/web/20160817193242/http://itpeernetwork.intel.com/iops-performance-nvme-hdd-configuration-windows-server-2016-storage-spaces-direct/">https://web.archive.org/web/20160817193242/http://itpeernetwork.intel.com/iops-performance-nvme-hdd-configuration-windows-server-2016-storage-spaces-direct/</a></li>
</ul>
<h2 id="os-disks">OS Disks</h2>
<p>In Dell Servers are BOSS (Boot Optimized Storage Solution) cards used. In essence it card wih 2x m2 2280 NVMe disks connected to PCI-e with configurable non-RAID/RAID 1</p>
<p><img src="AX750BOSS01.png" alt=""></p>
<p><img src="AX750BOSS02.png" alt=""></p>
<h2 id="consumer-grade-ssds">Consumer-Grade SSDs</h2>
<p>You should avoid any consumer grade SSDs as consumer grade SSDs might contain NAND with higher latency (therefore there can be performance drop after spilling FTL buffer) or because consumer grade SSDs are not power protected (PLP). You can learn more about why consumer-grade SSDs are not good idea in a <a href="https://techcommunity.microsoft.com/t5/storage-at-microsoft/don-t-do-it-consumer-grade-solid-state-drives-ssd-in-storage/ba-p/425914">blog post</a>. Consumer-grade SSDs do also have lower DWPD (Disk Written Per Day). You can learn about DWPD in <a href="https://blogs.technet.microsoft.com/filecab/2017/08/11/understanding-dwpd-tbw/">this blogpost</a></p>
<h2 id="exploring-stack-with-powershell">Exploring Stack with PowerShell</h2>
<h3 id="get-physicaldisk">Get-PhysicalDisk</h3>
<pre><code class="language-powershell">$Server = &quot;axnode1&quot;
Get-PhysicalDisk -CimSession $Server | Format-Table -Property FriendlyName, Manufacturer, Model, SerialNumber, MediaType, BusType, SpindleSpeed, LogicalSectorSize, PhysicalSectorSize
</code></pre>
<p><img src="PowerShell01.png" alt=""></p>
<p>From screenshot you can see, that AX640 BOSS card reports as SATA device with Unspecified Mediatype, while SAS disks are reported as SSDs, with SAS BusType. Let&rsquo;s deep dive into BusType/MediaType a little bit (see table below)</p>
<p><img src="BusType.png" alt=""></p>
<p>Storage Spaces requires BusType SATA/SAS/NVMe or SCM. BusType RAID is unsupported.</p>
<p>You can also see Logical Sector Size and Physical Sector size. This refers to Drive Type (4K native vs 512E vs 512).</p>
<table>
<thead>
<tr>
<th style="text-align:center">&ldquo;LogicalSectorSize&rdquo; value</th>
<th style="text-align:center">&ldquo;PhysicalSectorSize&rdquo; value</th>
<th style="text-align:center">Drive type</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">4096</td>
<td style="text-align:center">4096</td>
<td style="text-align:center">4K native</td>
</tr>
<tr>
<td style="text-align:center">512</td>
<td style="text-align:center">4096</td>
<td style="text-align:center">Advanced Format (also known as 512E)</td>
</tr>
<tr>
<td style="text-align:center">512</td>
<td style="text-align:center">512</td>
<td style="text-align:center">512-byte native</td>
</tr>
</tbody>
</table>
<p>Reference</p>
<ul>
<li><a href="https://learn.microsoft.com/en-US/troubleshoot/windows-server/backup-and-storage/support-policy-4k-sector-hard-drives">https://learn.microsoft.com/en-US/troubleshoot/windows-server/backup-and-storage/support-policy-4k-sector-hard-drives</a></li>
<li><a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/hh147334(v=ws.10)?redirectedfrom=MSDN">https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/hh147334(v=ws.10)?redirectedfrom=MSDN</a></li>
</ul>
<h3 id="storage-reliability-counter">Storage Reliability Counter</h3>
<p>Once disk is added to storage spaces, S.M.A.R.T. attributes can be filtered out. For reading disk status (such as wear level temperatures&hellip;) can be get-storagereliability counter used.</p>
<pre><code class="language-powershell">$Server = &quot;axnode1&quot;
Get-PhysicalDisk -CimSession $Server | Get-StorageReliabilityCounter -CimSession $Server | Format-Table -Property DeviceID, Wear, Temperature*, PowerOnHours, ManufactureDate, ReadLatencyMax, WriteLatencyMax, PSComputerName
</code></pre>
<p><img src="PowerShell02.png" alt=""></p>
<h2 id="performance-results">Performance results</h2>
<p>From the results below you can see that SATA vs SAS vs NVMe is 590092 vs 738507 vs 1496373 4k 100% read IOPS. All measurements were done with VMFleet 2.0 <a href="https://github.com/DellGEOS/AzureStackHOLs/tree/main/lab-guides/05-TestPerformanceWithVMFleet">https://github.com/DellGEOS/AzureStackHOLs/tree/main/lab-guides/05-TestPerformanceWithVMFleet</a></p>
<p>The difference between SAS and SATA is also 8 vs 4 disks in each node. The difference between SAS and NVMe is more than double.</p>
<ul>
<li><a href="AX6515-All-Flash-8SATA-SSDs-32VMs-2Node.txt">AX6515 - 2nodes, 16 cores and 4xSATA SSDs each</a></li>
<li><a href="AX6515-All-Flash-8SATA-SSDs-32VMs-2Node-SC-Dedup.txt">AX6515 - 2nodes, 16 cores and 4xSATA SSDs each, secured core and deduplication enabled</a></li>
<li><a href="AX6515-All-Flash-8SATA-SSDs-32VMs-2Node-SC.txt">AX6515 - 2nodes, 16 cores and 4xSATA SSDs each, secured core enabled</a></li>
<li><a href="AX6515-All-Flash-8SATA-SSDs-32VMs-2Node-SC-BitLocker.txt">AX6515 - 2nodes, 16 cores and 4xSATA SSDs each, secured core &amp; BitLocker enabled</a></li>
<li><a href="AX6515-All-Flash-16SAS-SSDs-32VMs-2nodes-azshci.txt">AX6515 - 2nodes, 16 cores and 8xSAS SSDs each</a></li>
<li><a href="R640-All-NVMe-16NVMe-64VMs-2Node.txt">R640 - 2nodes, 32 cores and 8xNVMe SSDs each</a></li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/dell/azurestack-docs" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2023 The Dell Technologies All Rights Reserved</small>
        <small class="ml-1"><a href="https://www.dell.com/learn/us/en/uscorp1/policies-privacy" target="_blank" rel="noopener">Privacy Policy</a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='https://dell.github.io/azurestack-docs/js/tabpane-persist.js'></script>




















<script src="https://dell.github.io/azurestack-docs/js/main.min.9f90c5deff5c6f69d5eaaf614a76a233d8b0b3ae70b942fc78919b6d08041034.js" integrity="sha256-n5DF3v9cb2nV6q9hSnaiM9iws65wuUL8eJGbbQgEEDQ=" crossorigin="anonymous"></script>



<script src='https://dell.github.io/azurestack-docs/js/prism.js'></script>

<script>
    

    var toggleIcon = document.getElementById("dark-mode-toggle");
    var toggleMenuItem = toggleIcon.parentElement;
    var toggleText = toggleMenuItem.childNodes[1]
    var nightOwlPrism = document.getElementById("prism-night-owl");
    var defaultPrism = $('link[href="https://dell.github.io/azurestack-docs/css/prism.css"]')[0].sheet

    if (toggleMenuItem) {
        toggleMenuItem.addEventListener("click", () => {
            if (toggleIcon.className === "fa fa-moon fa-lg") {
                setTheme("dark");
            } else if (toggleIcon.className === "fa fa-sun fa-lg") {
                setTheme("light");
            }
        });

        toggleMenuItem.removeAttribute("href")
    }

    function setTheme(mode) {
        localStorage.setItem("dark-mode-storage", mode);

        var darkTheme = document.getElementById("dark-mode-theme");

        if (mode === "dark") {
            darkTheme.disabled = false;
            nightOwlPrism.disabled = false;
            defaultPrism.disabled = true;
            toggleIcon.className = "fa fa-sun fa-lg";
            toggleText.textContent = "Light"
        } else if (mode === "light") {
            darkTheme.disabled = true;
            nightOwlPrism.disabled = true;
            defaultPrism.disabled = false;
            toggleIcon.className = "fa fa-moon fa-lg";
            toggleText.textContent = "Dark"
        }
    }

    
    var savedTheme = localStorage.getItem("dark-mode-storage") || "light";
    setTheme(savedTheme);
</script>


  </body>
</html>
